<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PricesAPI Debug Tool</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 30px;
    }
    .input-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    button {
      background: #007bff;
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .results {
      margin-top: 30px;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 5px;
      border-left: 4px solid #007bff;
    }
    .section h3 {
      margin-top: 0;
      color: #007bff;
    }
    pre {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      font-size: 12px;
      line-height: 1.5;
    }
    .product-card {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    .product-card h4 {
      margin: 0 0 10px 0;
      color: #333;
    }
    .offer-item {
      padding: 10px;
      margin: 5px 0;
      background: #f0f8ff;
      border-radius: 3px;
      border-left: 3px solid #007bff;
    }
    .error {
      color: #d32f2f;
      background: #ffebee;
      padding: 15px;
      border-radius: 5px;
      border-left: 4px solid #d32f2f;
    }
    .success {
      color: #388e3c;
      background: #e8f5e9;
      padding: 15px;
      border-radius: 5px;
      border-left: 4px solid #388e3c;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-card h4 {
      margin: 0 0 10px 0;
      font-size: 14px;
      opacity: 0.9;
    }
    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç PricesAPI Debug Tool</h1>
    
    <div class="input-group">
      <label for="apiKey">RapidAPI Key:</label>
      <input type="text" id="apiKey" value="6915393b67msh53d3dc15a192ddep1fbc58jsnbeeed16e35f8" placeholder="Enter your RapidAPI key">
    </div>
    
    <div class="input-group">
      <label for="productName">Product Name:</label>
      <input type="text" id="productName" value="Apple iPhone 15 128GB Blue" placeholder="e.g., Apple iPhone 15 128GB Blue">
    </div>
    
    <div class="input-group">
      <label for="country">Country:</label>
      <select id="country">
        <option value="in">India (IN)</option>
        <option value="us">United States (US)</option>
        <option value="uk">United Kingdom (UK)</option>
      </select>
    </div>
    
    <div class="input-group">
      <label for="searchLimit">Search Limit (products to fetch):</label>
      <input type="number" id="searchLimit" value="50" min="1" max="100">
    </div>
    
    <button onclick="searchProducts()">üîç Search Products</button>
    <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
    
    <div id="results" class="results"></div>
  </div>

  <script>
    let allProducts = [];
    let allOffers = [];

    async function searchProducts() {
      const apiKey = document.getElementById('apiKey').value.trim();
      const productName = document.getElementById('productName').value.trim();
      const country = document.getElementById('country').value;
      const searchLimit = parseInt(document.getElementById('searchLimit').value);
      const resultsDiv = document.getElementById('results');
      
      if (!apiKey || !productName) {
        resultsDiv.innerHTML = '<div class="error">‚ùå Please enter both API key and product name</div>';
        return;
      }
      
      resultsDiv.innerHTML = '<div class="success">‚è≥ Searching for products...</div>';
      
      try {
        // Step 1: Search for products
        const searchUrl = `https://real-time-product-search.p.rapidapi.com/search?q=${encodeURIComponent(productName)}&limit=${searchLimit}&country=${country}`;
        
        console.log('Search URL:', searchUrl);
        
        const searchResponse = await fetch(searchUrl, {
          method: 'GET',
          headers: {
            'X-RapidAPI-Key': apiKey,
            'X-RapidAPI-Host': 'real-time-product-search.p.rapidapi.com',
            'Accept': 'application/json'
          }
        });
        const searchData = await searchResponse.json();
        
        console.log('Search Response:', searchData);
        
        if (!searchResponse.ok) {
          throw new Error(`Search failed: ${JSON.stringify(searchData)}`);
        }
        
        allProducts = searchData.data || [];
        
        let html = `
          <div class="section">
            <h3>üìä Search Results</h3>
            <div class="stats">
              <div class="stat-card">
                <h4>Products Found</h4>
                <div class="value">${allProducts.length}</div>
              </div>
              <div class="stat-card">
                <h4>Search Query</h4>
                <div class="value" style="font-size: 18px;">${productName}</div>
              </div>
              <div class="stat-card">
                <h4>Country</h4>
                <div class="value">${country.toUpperCase()}</div>
              </div>
            </div>
          </div>
        `;
        
        if (allProducts.length === 0) {
          html += '<div class="error">‚ùå No products found. Try a different search term.</div>';
          resultsDiv.innerHTML = html;
          return;
        }
        
        // Step 2: Fetch offers for each product
        html += '<div class="section"><h3>üõí Fetching Offers from All Products...</h3></div>';
        resultsDiv.innerHTML = html;
        
        allOffers = [];
        const seenRetailers = new Set();
        
        for (let i = 0; i < Math.min(allProducts.length, 10); i++) {
          const product = allProducts[i];
          
          try {
            const offersUrl = `https://real-time-product-search.p.rapidapi.com/product/${product.product_id}?country=${country}`;
            console.log(`Fetching offers for product ${i + 1}:`, product.product_title);
            
            const offersResponse = await fetch(offersUrl, {
              method: 'GET',
              headers: {
                'X-RapidAPI-Key': apiKey,
                'X-RapidAPI-Host': 'real-time-product-search.p.rapidapi.com',
                'Accept': 'application/json'
              }
            });
            const offersData = await offersResponse.json();
            
            console.log(`Offers for "${product.product_title}":`, offersData);
            
            if (offersData.data && offersData.data.offers && offersData.data.offers.length > 0) {
              console.log('Found', offersData.data.offers.length, 'offers for this product');
              
              offersData.data.offers.forEach(offer => {
                const retailerDomain = extractDomain(offer.offer_page_url);
                if (!seenRetailers.has(retailerDomain)) {
                  seenRetailers.add(retailerDomain);
                  allOffers.push({
                    product: product.product_title,
                    retailer: offer.store_name || retailerDomain,
                    price: parseFloat(offer.price.replace(/[^0-9.]/g, '')),
                    currency: '‚Çπ',
                    url: offer.offer_page_url,
                    domain: retailerDomain,
                    availability: offer.store_rating ? `Rating: ${offer.store_rating}` : 'Check Availability'
                  });
                }
              });
            }
          } catch (err) {
            console.error(`Error fetching offers for product ${product.id}:`, err);
          }
        }
        
        // Display results
        displayResults(allProducts, allOffers, searchData);
        
      } catch (error) {
        console.error('Error:', error);
        resultsDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
      }
    }
    
    function extractDomain(url) {
      try {
        return new URL(url).hostname.replace('www.', '');
      } catch {
        return 'unknown';
      }
    }
    
    function displayResults(products, offers, rawData) {
      const resultsDiv = document.getElementById('results');
      
      let html = `
        <div class="section">
          <h3>üìä Summary</h3>
          <div class="stats">
            <div class="stat-card">
              <h4>Products Found</h4>
              <div class="value">${products.length}</div>
            </div>
            <div class="stat-card">
              <h4>Unique Retailers</h4>
              <div class="value">${offers.length}</div>
            </div>
            <div class="stat-card">
              <h4>Lowest Price</h4>
              <div class="value" style="font-size: 20px;">${offers.length > 0 ? offers[0].currency + Math.min(...offers.map(o => o.price)).toLocaleString() : 'N/A'}</div>
            </div>
          </div>
        </div>
      `;
      
      // Show all unique retailers found
      if (offers.length > 0) {
        offers.sort((a, b) => a.price - b.price);
        
        html += `
          <div class="section">
            <h3>üè™ All Retailers Found (${offers.length})</h3>
        `;
        
        offers.forEach((offer, index) => {
          const savings = index > 0 ? offers[0].price - offer.price : 0;
          html += `
            <div class="offer-item">
              <strong>${offer.retailer}</strong> (${offer.domain})<br>
              <strong>Price:</strong> ${offer.currency}${offer.price.toLocaleString()}<br>
              <strong>Product:</strong> ${offer.product}<br>
              <strong>Availability:</strong> ${offer.availability}<br>
              <a href="${offer.url}" target="_blank">View Product ‚Üí</a>
              ${index === 0 ? '<span style="color: green; font-weight: bold;"> üèÜ BEST PRICE</span>' : ''}
            </div>
          `;
        });
        
        html += '</div>';
      } else {
        html += '<div class="error">‚ùå No offers found from any retailer</div>';
      }
      
      // Show first 5 products
      html += `
        <div class="section">
          <h3>üì¶ Products Found (showing first 5)</h3>
      `;
      
      products.slice(0, 5).forEach((product, index) => {
        html += `
          <div class="product-card">
            <h4>${index + 1}. ${product.product_title}</h4>
            <p><strong>ID:</strong> ${product.product_id}</p>
            ${product.offer?.store_name ? `<p><strong>Store:</strong> ${product.offer.store_name}</p>` : ''}
            ${product.product_star_rating ? `<p><strong>Rating:</strong> ${product.product_star_rating} ‚≠ê</p>` : ''}
            ${product.offer?.price ? `<p><strong>Price:</strong> ${product.offer.price}</p>` : ''}
          </div>
        `;
      });
      
      html += '</div>';
      
      // Show raw JSON
      html += `
        <div class="section">
          <h3>üìÑ Raw API Response (Search)</h3>
          <pre>${JSON.stringify(rawData, null, 2)}</pre>
        </div>
      `;
      
      resultsDiv.innerHTML = html;
    }
    
    function clearResults() {
      document.getElementById('results').innerHTML = '';
      allProducts = [];
      allOffers = [];
    }
  </script>
</body>
</html>
